<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Test</title>
</head>
<body>
  <h1>WebSocket Test</h1>
  <input type="text" id="messageInput" placeholder="ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ› (ä¾‹: ls, pwd)" />
  <button onclick="sendMessage()">å®Ÿè¡Œ</button>
  <pre id="log"></pre>

  <script>
    const log = document.getElementById('log');
    // Dockerç’°å¢ƒã§ã®WebSocketæ¥ç¶šURL
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨
    const wsHost = window.location.hostname === 'localhost' ? 'localhost' : '192.168.97.1';
    const ws = new WebSocket(`ws://${wsHost}:8000/api/v1/cable`);
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸€åº¦ã ã‘ï¼‰
    const sessionId = crypto.randomUUID();
    log.textContent += `ğŸ”Œ æ¥ç¶šå…ˆ: ws://${wsHost}:8000/api/v1/cable\n`;
    log.textContent += `ğŸ”‘ ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}\n`;

    ws.onopen = () => {
      log.textContent += 'âœ… æ¥ç¶šã—ã¾ã—ãŸ\n';
      // ActionCableã®æ¥ç¶šç¢ºç«‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      ws.send(JSON.stringify({
        command: 'subscribe',
        identifier: JSON.stringify({
          channel: 'CommandChannel'
        })
      }));
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === 'welcome') {
          log.textContent += 'âœ… ActionCableæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ\n';
        } else if (data.type === 'confirm_subscription') {
          log.textContent += 'âœ… ãƒãƒ£ãƒ³ãƒãƒ«ã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã¾ã—ãŸ\n';
        } else if (data.message) {
          if (data.message.result) {
            log.textContent += `ğŸ“¨ å®Ÿè¡Œçµæœ:\n${data.message.result}\n`;
          } else if (data.message.error) {
            log.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.message.error}\n`;
            if (data.message.result) {
              log.textContent += `ğŸ“¨ å®Ÿè¡Œçµæœ(ã‚¨ãƒ©ãƒ¼æ™‚):\n${data.message.result}\n`;
            }
          }
          // ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¡¨ç¤º
          if (data.message.pwd) {
            log.textContent += `ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${data.message.pwd}\n`;
          }
        } else {
          // log.textContent += `ğŸ“¨ å—ä¿¡: ${event.data}\n`;
        }
      } catch (e) {
        // log.textContent += `ğŸ“¨ å—ä¿¡: ${event.data}\n`;
      }
    };

    ws.onclose = () => {
      log.textContent += 'ğŸ”Œ æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ\n';
    };

    ws.onerror = (error) => {
      log.textContent += `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${error}\n`;
    };

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const command = input.value.trim();
      
      if (!command) return;

      // ã‚³ãƒãƒ³ãƒ‰ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      const message = {
        command: command,
        session_id: sessionId
      };

      // ActionCableã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦é€ä¿¡
      ws.send(JSON.stringify({
        command: 'message',
        identifier: JSON.stringify({
          channel: 'CommandChannel'
        }),
        data: JSON.stringify({
          action: 'execute_command',
          command: JSON.stringify(message) // ã‚³ãƒãƒ³ãƒ‰ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å«ã‚€JSONã‚’æ–‡å­—åˆ—åŒ–
        })
      }));

      log.textContent += `ğŸ“¤ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ: ${command}\n`;
      input.value = '';
    }
  </script>
</body>
</html>
